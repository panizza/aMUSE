from ajaxutils.decorators import ajax
from django.contrib.auth.models import User
from .helpers import save_image
from django.shortcuts import get_object_or_404
from django.forms.models import model_to_dict
from basetyzer.models import Item, Tag, Experience, Photo, Scan, Action,\
    Comment

@ajax(require="GET")
def get_item(request, id_item):
    """ Provides information regarding a specific object identified by id
    """
    item = get_object_or_404(Item, pk=id_item)
    item_json = model_to_dict(item, exclude=['exhibit'])
    item_json['tag'] = model_to_dict(Tag.objects.get(pk=int(item_json['tag'])))
    item_json['photo'] = item_json['photo'].url
    return item_json

@ajax(require="POST")
def save_visit(request):

    """data = {"exp": [{"date": "2013-03-12 14:46:10","photo": "",
                     "text": "bingo bongo","type": "personal"},
                    {"id": "1","date": "2013-03-12 14:46:10","photo": "",
                     "text": "woow","type":"scan"},
                    {"id": "2","date": "2013-03-12 14:46:10",
                     "photo": "","text": "","type": "scan"},
                    {"date": "2013-03-12 14:46:10",
                     "photo":"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","text":"vermi!","type":"personal"}],"confirm": "44221100","email": "gpinelli@excite.it"}
    """
    data = request.data
    email = data['email']
    confirm = data['confirm']
    experience = data['exp']
    user, created = User.objects.get_or_create(username=email, email=email)
    my_experience = Experience.objects.create(user=user)
    for exp in experience:
        action = Action()
        action.date_performed = exp['date']
        action.experience = my_experience
        if exp['type'] == 'scan':
            item = Item.objects.get(id=exp['id'])
            scan = Scan.objects.create(content=item)
            action.scan = scan
        if not exp.get('photo', '') == '':
            name, content = save_image(exp['photo'])
            photo = Photo()
            photo.content.save(name,content)
            action.photo = photo

        if not exp.get('text', '') == '':
            comment = Comment.objects.create(content=exp['text'])
            action.comment = comment
        action.save()


